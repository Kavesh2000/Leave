<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin — Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-sm navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Leave System — Admin</a>
        <div class="d-flex">
          <button id="logout" class="btn btn-outline-light btn-sm">Logout</button>
        </div>
      </div>
    </nav>
    <main class="container-fluid py-4">
      <div class="row">
        <aside class="col-md-3 mb-3">
          <div class="card shadow-sm h-100">
            <div class="card-body p-2">
              <div class="d-flex align-items-center mb-3">
                <span class="brand-mark"></span>
                <div>
                  <div class="fw-bold">Admin</div>
                  <div id="adminDept" class="text-muted small">Department</div>
                </div>
              </div>
              <div class="list-group">
                <button class="list-group-item list-group-item-action active" data-view="requests">Requests</button>
                <button class="list-group-item list-group-item-action" data-view="balances">Balances</button>
                <button class="list-group-item list-group-item-action" data-view="analytics">Analytics</button>
                <button class="list-group-item list-group-item-action" data-view="departments">Departments</button>
                <button class="list-group-item list-group-item-action" data-view="createUser">Create User</button>
                <button class="list-group-item list-group-item-action" data-view="users">Users</button>
              </div>
            </div>
          </div>
        </aside>
        <section class="col-md-9">
          <div id="view-requests" class="view">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <h5 class="card-title">Requests</h5>
                <ul id="requests" class="list-group"></ul>
              </div>
            </div>
          </div>

          <div id="view-balances" class="view d-none">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <h5 class="card-title">Balances</h5>
                <div id="balances"></div>
              </div>
            </div>
          </div>

          <div id="view-analytics" class="view d-none">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <h5 class="card-title">Analytics</h5>
                <div class="row">
                  <div class="col-md-6"><canvas id="chart-dept"></canvas></div>
                  <div class="col-md-6"><canvas id="chart-type"></canvas></div>
                </div>
              </div>
            </div>
          </div>

          <div id="view-createUser" class="view d-none">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <h5 class="card-title">Create User</h5>
                <form id="createUserForm">
                  <div class="mb-2"><input class="form-control" placeholder="Full name" id="u_full_name" required></div>
                  <div class="mb-2"><input class="form-control" placeholder="Email" id="u_email" type="email" required></div>
                  <div class="mb-2"><input class="form-control" placeholder="Password" id="u_password" type="password" required></div>
                  <div class="mb-2">
                    <select id="u_role" class="form-select">
                      <option value="employee">Employee</option>
                      <option value="HOD">HOD</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>
                  <div class="mb-2"><input class="form-control" placeholder="Department (optional)" id="u_department"></div>
                  <div class="d-grid"><button class="btn btn-primary">Create</button></div>
                </form>
              </div>
            </div>
          </div>

          <div id="view-departments" class="view d-none">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <h5 class="card-title">Departments</h5>
                <div class="mb-3 d-flex gap-2">
                  <input id="deptName" class="form-control" placeholder="Department name">
                  <select id="deptHod" class="form-select" style="width:320px">
                    <option value="">(No HOD)</option>
                  </select>
                  <button id="createDept" class="btn btn-primary">Create</button>
                </div>
                <div id="departmentsList"></div>
              </div>
            </div>
          </div>

          <div id="view-users" class="view d-none">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <h5 class="card-title">Users</h5>
                <div id="usersList"></div>
                <!-- Reset password modal -->
                <div id="resetModal" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index:1200;backdrop-filter:blur(2px)">
                  <div class="d-flex vh-100 align-items-center justify-content-center">
                    <div class="card p-3 modal-fade" style="width:420px">
                      <h6>Reset password for <span id="resetName"></span></h6>
                      <input id="resetPassword" class="form-control mb-2" placeholder="New password" type="password">
                      <div class="d-flex justify-content-end gap-2"><button id="resetCancel" class="btn btn-outline-secondary">Cancel</button><button id="resetSubmit" class="btn btn-primary">Reset</button></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <script>
    async function load(){
      try{ const me = await (await fetch('/api/me')).json(); if(me && me.department) document.getElementById('adminDept').textContent = me.department; }catch(e){}
      bindSidebar();
      await refreshRequests();
      await refreshBalances();
      await refreshUsers();
      await refreshAnalytics();
      showView('requests');
    }

    function bindSidebar(){
      document.querySelectorAll('.list-group .list-group-item').forEach(btn=> btn.onclick = ()=>{
        document.querySelectorAll('.list-group .list-group-item').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        showView(btn.getAttribute('data-view'));
      });
    }

    function showView(name){
      document.querySelectorAll('.view').forEach(v=> v.classList.add('d-none'));
      const el = document.getElementById('view-' + name);
      if(el) el.classList.remove('d-none');
      if(name === 'analytics') refreshAnalytics();
    }

    async function refreshRequests(){
      const r = await (await fetch('/api/leave_requests')).json(); const el=document.getElementById('requests'); el.innerHTML='';
      r.forEach(x=>{
        const li=document.createElement('li'); li.className='list-group-item';
        li.innerHTML = `<div class='d-flex justify-content-between align-items-start'><div><b>${x.full_name}</b><div class='small text-muted'>${x.leave_type} ${x.start_date} → ${x.end_date} (${x.days})</div></div><div><button class='btn btn-sm btn-success me-1' data-id='${x.id}' data-act='approve'>Approve</button><button class='btn btn-sm btn-danger' data-id='${x.id}' data-act='reject'>Reject</button></div></div>`;
        el.appendChild(li);
      });
      document.querySelectorAll('button[data-id]').forEach(btn=>btn.onclick=async e=>{
        const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act'); const comment = prompt('Comment')||'';
        const res = await fetch('/api/leave_requests/'+id+'/admin_action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:act,comment})});
        if(res.ok) { await refreshRequests(); await refreshBalances(); } else alert(JSON.stringify(await res.json()));
      });
    }

    async function refreshBalances(){
      const b = await (await fetch('/api/balances')).json(); const be=document.getElementById('balances'); be.innerHTML='';
      b.forEach(x=>{ const row=document.createElement('div'); row.className='mb-2 d-flex gap-2 align-items-center'; row.innerHTML = `<div class='flex-grow-1'><strong>${x.full_name}</strong><div class='text-muted small'>${x.leave_type}</div></div><input class='form-control form-control-sm' style='width:90px' value='${x.remaining_days}' data-user='${x.user_id}' data-type='${x.leave_type_id}'/><button class='btn btn-sm btn-primary' data-save='${x.user_id}-${x.leave_type_id}'>Save</button>`; be.appendChild(row); });
      document.querySelectorAll('button[data-save]').forEach(btn=>btn.onclick=async ()=>{ const key = btn.getAttribute('data-save'); const [u,t]=key.split('-'); const input = btn.previousElementSibling; const val = parseInt(input.value); const res = await fetch(`/api/balances/${u}/${t}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({remaining_days:val})}); if(res.ok) { await refreshBalances(); } else alert(JSON.stringify(await res.json())); });
    }

    async function refreshAnalytics(){
      try{
        const d = await (await fetch('/api/analytics/departments')).json();
        const t = await (await fetch('/api/analytics/types')).json();
        const deptLabels = d.map(r=> r.department || 'Unknown');
        const deptData = d.map(r=> r.days || 0);
        const typeLabels = t.map(r=> r.type);
        const typeData = t.map(r=> r.days || 0);
        // destroy existing charts if present
        if(window._deptChart) window._deptChart.destroy();
        if(window._typeChart) window._typeChart.destroy();
        const ctxD = document.getElementById('chart-dept').getContext('2d');
        window._deptChart = new Chart(ctxD, {type:'bar', data:{labels:deptLabels, datasets:[{label:'Leave days', data:deptData, backgroundColor:'#7c3aed'}]}});
        const ctxT = document.getElementById('chart-type').getContext('2d');
        window._typeChart = new Chart(ctxT, {type:'pie', data:{labels:typeLabels, datasets:[{data:typeData, backgroundColor:['#4f46e5','#06b6d4','#f59e0b']} ]}});
      }catch(e){ console.error(e); }
    }

    document.addEventListener('submit', async e =>{
      if(e.target && e.target.id === 'createUserForm'){
        e.preventDefault();
        const full_name = document.getElementById('u_full_name').value;
        const email = document.getElementById('u_email').value;
        const password = document.getElementById('u_password').value;
        const role = document.getElementById('u_role').value;
        const department = document.getElementById('u_department').value || null;
        const res = await fetch('/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({full_name,email,password,role,department})});
        if(res.ok){ alert('User created'); e.target.reset(); await refreshUsers(); await refreshBalances(); } else alert(JSON.stringify(await res.json()));
      }
    });

    // Reset password modal handlers
    document.getElementById('resetCancel').onclick = ()=>{ document.querySelector('#resetModal .modal-fade').classList.remove('show'); setTimeout(()=> document.getElementById('resetModal').classList.add('d-none'),220); };
    document.getElementById('resetSubmit').onclick = async ()=>{
      const id = document.getElementById('resetModal').dataset.userId; const pw = document.getElementById('resetPassword').value;
      if(!pw){ alert('Enter a password'); return; }
      const res = await fetch('/api/users/'+id+'/reset_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
      if(res.ok){ showToast('Password reset'); document.getElementById('resetPassword').value=''; document.getElementById('resetCancel').click(); } else { const j=await res.json(); showToast('Error: '+(j.error||'')); }
    };

    async function refreshUsers(){
      const users = await (await fetch('/api/users')).json();
      const balances = await (await fetch('/api/balances')).json();
      const depts = await (await fetch('/api/departments')).json();
      const list = document.getElementById('usersList');
      
      // Build map: department name -> HOD name
      const deptHodMap = {};
      depts.forEach(d=> deptHodMap[d.name] = d.hod_name || '(none)');
      
      // Build map: user_id -> {annual, sick}
      const userBalanceMap = {};
      balances.forEach(b=>{
        if(!userBalanceMap[b.user_id]) userBalanceMap[b.user_id] = {};
        userBalanceMap[b.user_id][b.leave_type] = b.remaining_days;
      });
      
      // Create table
      let html = `<table class='table table-sm table-hover'><thead><tr><th>Name</th><th>Department</th><th>HOD</th><th>Annual</th><th>Sick</th><th>Actions</th></tr></thead><tbody>`;
      users.forEach(u=>{
        const annual = userBalanceMap[u.id]?.Annual || 0;
        const sick = userBalanceMap[u.id]?.Sick || 0;
        const hod = deptHodMap[u.department] || '—';
        html += `<tr>
          <td><strong>${u.full_name}</strong><div class='text-muted small'>${u.email}</div></td>
          <td>${u.department || '—'}</td>
          <td>${hod}</td>
          <td>${annual}</td>
          <td>${sick}</td>
          <td>
            <button class='btn btn-sm btn-outline-secondary me-1' data-edit='${u.id}'>Edit</button>
            <button class='btn btn-sm btn-outline-warning me-1' data-reset='${u.id}' data-name='${u.full_name}'>Reset PW</button>
            <button class='btn btn-sm btn-danger' data-delete='${u.id}'>Delete</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
      list.innerHTML = html;
      
      // wire edit and reset buttons
      document.querySelectorAll('button[data-edit]').forEach(btn=> btn.onclick = async ()=>{
        const id = btn.getAttribute('data-edit');
        const u = users.find(x=> x.id==id);
        const newDept = prompt('Department', u.department||'') || null;
        const newRole = prompt('Role (employee/HOD/admin)', u.role) || u.role;
        const newName = prompt('Full name', u.full_name) || u.full_name;
        const res = await fetch('/api/users/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({full_name:newName, role:newRole, department:newDept})});
        if(res.ok) { showToast('Updated'); await refreshUsers(); await refreshBalances(); } else showToast('Error');
      });
      document.querySelectorAll('button[data-reset]').forEach(btn=> btn.onclick = ()=>{
        const id = btn.getAttribute('data-reset'); const name = btn.getAttribute('data-name');
        document.getElementById('resetName').textContent = name; document.getElementById('resetModal').dataset.userId = id;
        document.getElementById('resetModal').classList.remove('d-none'); setTimeout(()=> document.querySelector('#resetModal .modal-fade').classList.add('show'),10);
      });
      document.querySelectorAll('button[data-delete]').forEach(btn=> btn.onclick = async ()=>{
        const id = btn.getAttribute('data-delete');
        if(!confirm('Delete this user? This will remove their leaves and balances.')) return;
        const res = await fetch('/api/users/'+id, { method: 'DELETE' });
        if(res.ok){ showToast('User deleted'); await refreshUsers(); await refreshBalances(); } else { showToast('Error deleting'); }
      });
    }

    // Departments UI
    async function refreshDepartments(){
      // populate hod select with users
      const users = await (await fetch('/api/users')).json();
      const hodSelect = document.getElementById('deptHod'); hodSelect.innerHTML = '<option value="">(No HOD)</option>';
      users.forEach(u=>{ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = `${u.full_name} (${u.email})`; hodSelect.appendChild(opt); });

      const deps = await (await fetch('/api/departments')).json();
      const container = document.getElementById('departmentsList'); container.innerHTML = '';
      deps.forEach(d=>{
        const row = document.createElement('div'); row.className = 'd-flex align-items-center justify-content-between mb-2';
        row.innerHTML = `<div><strong>${d.name}</strong><div class='small text-muted'>HOD: ${d.hod_name||'(none)'} ${d.hod_email?'<span class="text-muted">• '+d.hod_email+'</span>':''}</div></div><div><button class='btn btn-sm btn-outline-secondary me-1' data-edit='${d.id}'>Edit</button><button class='btn btn-sm btn-danger' data-delete='${d.id}'>Delete</button></div>`;
        container.appendChild(row);
      });

      document.getElementById('createDept').onclick = async ()=>{
        const name = document.getElementById('deptName').value.trim(); const hod = document.getElementById('deptHod').value || null;
        if(!name) return alert('Enter department name');
        const res = await fetch('/api/departments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name, hod_user_id: hod || null})});
        if(res.ok){ document.getElementById('deptName').value=''; await refreshDepartments(); await refreshUsers(); } else alert(JSON.stringify(await res.json()));
      };

      document.querySelectorAll('button[data-edit]').forEach(btn=> btn.onclick = async ()=>{
        const id = btn.getAttribute('data-edit');
        const d = deps.find(x=> x.id==id);
        const newName = prompt('Department name', d.name) || d.name;
        const hod = prompt('HOD user id (empty to clear)', d.hod_user_id||'') || null;
        const payload = { name: newName, hod_user_id: hod || null };
        const res = await fetch('/api/departments/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(res.ok) { await refreshDepartments(); await refreshUsers(); } else alert(JSON.stringify(await res.json()));
      });

      document.querySelectorAll('button[data-delete]').forEach(btn=> btn.onclick = async ()=>{
        const id = btn.getAttribute('data-delete'); if(!confirm('Delete this department?')) return;
        const res = await fetch('/api/departments/'+id, { method: 'DELETE' });
        if(res.ok){ showToast('Department deleted'); await refreshDepartments(); await refreshUsers(); } else { alert(JSON.stringify(await res.json())); }
      });
    }

    // Theme toggle
    function applyTheme(){ if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark'); else document.body.classList.remove('dark'); }
    const themeBtn = document.getElementById('themeToggle'); if(themeBtn) themeBtn.onclick = ()=>{ const isDark = document.body.classList.toggle('dark'); localStorage.setItem('theme', isDark? 'dark':'light'); };
    applyTheme();

    document.getElementById('logout').onclick = async ()=>{ await fetch('/api/logout',{method:'POST'}); location.href='/'; };
    load();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>