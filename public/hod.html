<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HOD — Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-sm navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Leave System — HOD</a>
        <div class="d-flex">
          <button id="themeToggle" class="btn btn-outline-light btn-sm me-2">Theme</button>
          <button id="logout" class="btn btn-outline-light btn-sm">Logout</button>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="row gy-3">
        <div class="col-12">
          <h4>Approval Queue</h4>
        </div>
        <div id="cards" class="col-12 d-grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem"></div>
      </div>
    </main>

    <!-- comment modal -->
    <div id="commentModal" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index:1100;backdrop-filter:blur(2px)">
      <div class="d-flex vh-100 align-items-center justify-content-center">
        <div class="card p-3 shadow-lg modal-fade" style="width:480px">
          <h5 id="commentTitle">Add comment</h5>
          <textarea id="commentText" class="form-control" rows="4"></textarea>
          <div class="d-flex justify-content-end gap-2 mt-2">
            <button id="commentCancel" class="btn btn-outline-secondary">Cancel</button>
            <button id="commentSubmit" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    function showToast(msg){ const wrap = document.querySelector('.toast-wrap') || (function(){ const d=document.createElement('div'); d.className='toast-wrap'; document.body.appendChild(d); return d; })(); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; wrap.appendChild(t); setTimeout(()=> t.remove(),3500); }
    let currentAction = null;
    async function load(){ refresh(); }
    async function refresh(){
      const r = await (await fetch('/api/leave_requests')).json(); const container=document.getElementById('cards'); container.innerHTML='';
      r.forEach(x=>{
        const div = document.createElement('div'); div.className='card p-3 hover-scale';
        const statusColor = x.status === 'pending' ? '#ffc107' : x.status === 'hod_approved' ? '#28a745' : '#dc3545';
        const statusText = x.status === 'pending' ? '⏳ Pending' : x.status === 'hod_approved' ? '✓ Approved' : '✗ Rejected';
        const actionButtons = x.status === 'pending' ? `<button class='btn btn-sm btn-success' data-id='${x.id}' data-act='approve'>Approve</button><button class='btn btn-sm btn-danger' data-id='${x.id}' data-act='reject'>Reject</button>` : '';
        div.innerHTML = `<div class='d-flex justify-content-between'><div><strong>${x.full_name}</strong><div class='small text-muted'>${x.department || ''}</div></div><div class='text-end'><div class='small text-muted'>${x.leave_type}</div><div class='h5'>${x.days} days</div></div></div><div class='mt-2'><div class='text-muted small'>${x.start_date} → ${x.end_date}</div><div class='mt-2'><span style='background:${statusColor};color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;'>${statusText}</span></div></div><div class='mt-3 d-flex gap-2 justify-content-end'>${actionButtons}</div>`;
        container.appendChild(div);
      });
      document.querySelectorAll('button[data-id]').forEach(btn=>btn.onclick=async e=>{
        const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
        currentAction = {id, act};
        document.getElementById('commentTitle').textContent = act==='approve' ? 'Approve with comment (optional)' : 'Reject with comment';
        document.getElementById('commentText').value='';
        document.getElementById('commentModal').classList.remove('d-none'); setTimeout(()=> document.querySelector('.modal-fade').classList.add('show'),10);
      });
    }

    document.getElementById('commentCancel').onclick = ()=>{ document.querySelector('.modal-fade').classList.remove('show'); setTimeout(()=> document.getElementById('commentModal').classList.add('d-none'),220); };
    document.getElementById('commentSubmit').onclick = async ()=>{
      const comment = document.getElementById('commentText').value || '';
      const {id, act} = currentAction || {};
      const res = await fetch('/api/leave_requests/'+id+'/hod_action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:act==='approve'?'approve':'reject',comment})});
      if(res.ok){ showToast('Action submitted'); document.getElementById('commentCancel').click(); await refresh(); } else { showToast('Error'); }
    };

    // Theme toggle
    function applyTheme(){ if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark'); else document.body.classList.remove('dark'); }
    document.getElementById('themeToggle').onclick = ()=>{ const isDark = document.body.classList.toggle('dark'); localStorage.setItem('theme', isDark? 'dark':'light'); };
    applyTheme();

    document.getElementById('logout').onclick = async ()=>{ await fetch('/api/logout',{method:'POST'}); location.href='/'; };
    load();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>