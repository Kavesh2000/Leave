<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Employee ‚Äî Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-sm navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Leave System</a>
        <div class="d-flex">
          <button id="themeToggle" class="btn btn-outline-light btn-sm me-2">Theme</button>
          <button id="logout" class="btn btn-outline-light btn-sm">Logout</button>
        </div>
      </div>
    </nav>
    <main class="container py-4">
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="m-0">Dashboard</h4>
          <div>
            <button id="openApply" class="btn btn-primary hover-scale">Apply Leave</button>
          </div>
        </div>
        <div class="row gap-6">
          <div class="col-sm-6 col-lg-3">
            <div class="card p-3 hover-scale" style="background:linear-gradient(90deg,#fff7ed,#fffaf0)">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="h2" id="card-annual">-</div>
                  <div class="text-muted">Annual Leave Remaining</div>
                </div>
                <div><span class="badge bg-white text-muted">üå¥</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card p-3 hover-scale" style="background:linear-gradient(90deg,#ecfeff,#f0f9ff)">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="h2" id="card-sick">-</div>
                  <div class="text-muted">Sick Leave Remaining</div>
                </div>
                <div><span class="badge bg-white text-muted">ü§í</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card p-3 hover-scale" style="background:linear-gradient(90deg,#fffbea,#fffef0)">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="h2" id="card-pending">-</div>
                  <div class="text-muted">Pending Requests</div>
                </div>
                <div><span class="badge bg-white text-muted">‚è≥</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card p-3 hover-scale" style="background:linear-gradient(90deg,#f0fdf4,#f7fff5)">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="h2" id="card-taken">-</div>
                  <div class="text-muted">Total Leave Taken</div>
                </div>
                <div><span class="badge bg-white text-muted">üìä</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">Leave History</h5>
          <div class="table-responsive">
            <table class="table table-hover modern-table">
              <thead><tr><th>Type</th><th>From</th><th>To</th><th>Days</th><th>Status</th></tr></thead>
              <tbody id="history"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Apply Modal -->
    <div id="applyModal" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index:1100;backdrop-filter:blur(2px)">
      <div class="d-flex vh-100 align-items-center justify-content-center">
        <div class="card p-4 shadow-lg modal-fade" style="width:540px">
          <h5>Apply Leave</h5>
          <form id="applyForm">
            <div class="row g-2">
              <div class="col-md-6"><label class="form-label">Type</label><select id="m_lt" class="form-select"></select></div>
              <div class="col-md-6"><label class="form-label">Days (calculated)</label><input id="m_days" class="form-control" readonly></div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-6"><label class="form-label">Start</label><input id="m_start" type="date" class="form-control"></div>
              <div class="col-md-6"><label class="form-label">End</label><input id="m_end" type="date" class="form-control"></div>
            </div>
            <div class="mb-2 mt-2"><label class="form-label">Reason</label><input id="m_reason" class="form-control"></div>
            <div class="d-flex justify-content-end gap-2">
              <button type="button" id="m_cancel" class="btn btn-outline-secondary">Cancel</button>
              <button class="btn btn-primary">Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
    let HOLIDAYS = [];
    async function awaitFetchHolidays(){
      try{ const res = await fetch('/api/holidays'); if(res.ok) return await res.json(); }catch(e){}
      return [];
    }

    function badgeFor(status){
      if(status==='pending') return `<span class='badge badge-pending'>Pending</span>`;
      if(status==='hod_approved' || status==='admin_approved') return `<span class='badge badge-approved'>Approved</span>`;
      return `<span class='badge badge-rejected'>Rejected</span>`;
    }

    async function load(){
      HOLIDAYS = await awaitFetchHolidays();
      const lt = await (await fetch('/api/leave_types')).json();
      const sel = document.getElementById('m_lt');
      sel.innerHTML=''; lt.forEach(t=> { const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o); });
      // fill cards and history
      await refreshSummary();
      await refreshHistory();
    }

    async function refreshSummary(){
      const balances = await (await fetch('/api/balances')).json();
      let annual = 0, sick = 0;
      balances.forEach(b=>{ if(b.leave_type==='Annual') annual = b.remaining_days; if(b.leave_type==='Sick') sick = b.remaining_days; });
      document.getElementById('card-annual').textContent = annual;
      document.getElementById('card-sick').textContent = sick;
      const reqs = await (await fetch('/api/leave_requests')).json();
      document.getElementById('card-pending').textContent = reqs.filter(r=>r.status==='pending').length;
      // total taken (approved)
      const total = reqs.filter(r=>r.status==='admin_approved').reduce((s,r)=>s + (r.days||0),0);
      document.getElementById('card-taken').textContent = total;
    }

    async function refreshHistory(){
      const r = await (await fetch('/api/leave_requests')).json();
      const tb = document.getElementById('history'); tb.innerHTML='';
      r.forEach(x=>{
        const tr = document.createElement('tr');
        tr.className='hover-scale';
        tr.innerHTML = `<td>${x.leave_type}</td><td>${x.start_date}</td><td>${x.end_date}</td><td>${x.days}</td><td>${badgeFor(x.status)}</td>`;
        tb.appendChild(tr);
      });
    }

    // Apply modal logic
    document.getElementById('openApply').onclick = ()=>{
      document.getElementById('applyModal').classList.remove('d-none');
      setTimeout(()=> document.querySelector('.modal-fade').classList.add('show'),10);
    };
    document.getElementById('m_cancel').onclick = ()=>{
      document.querySelector('.modal-fade').classList.remove('show');
      setTimeout(()=> document.getElementById('applyModal').classList.add('d-none'),220);
    };

    async function calcDays(start,end){
      if(!start || !end) return 0;
      const res = await fetch('/api/calc_days',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({start_date:start,end_date:end})});
      if(res.ok){ const j = await res.json(); return j.days; }
      return 0;
    }

    // initialize flatpickr
    flatpickr('#m_start', {dateFormat:'Y-m-d', onChange: async function(selectedDates, dateStr){ const d = await calcDays(dateStr, document.getElementById('m_end').value); document.getElementById('m_days').value = d; }});
    flatpickr('#m_end', {dateFormat:'Y-m-d', onChange: async function(selectedDates, dateStr){ const d = await calcDays(document.getElementById('m_start').value, dateStr); document.getElementById('m_days').value = d; }});

    document.getElementById('applyForm').onsubmit = async e =>{
      e.preventDefault();
      const leave_type_id = parseInt(document.getElementById('m_lt').value);
      const start_date = document.getElementById('m_start').value;
      const end_date = document.getElementById('m_end').value;
      const reason = document.getElementById('m_reason').value;
      const res = await fetch('/api/apply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({leave_type_id,start_date,end_date,reason})});
      if(res.ok){ showToast('Leave applied'); document.getElementById('m_cancel').click(); await refreshSummary(); await refreshHistory(); } else { const j=await res.json(); showToast('Error: '+(j.error||'')); }
    };

    function showToast(msg){ const wrap = document.querySelector('.toast-wrap') || (function(){ const d=document.createElement('div'); d.className='toast-wrap'; document.body.appendChild(d); return d; })(); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; wrap.appendChild(t); setTimeout(()=> t.remove(),3500); }

    // Theme toggle
    function applyTheme(){ if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark'); else document.body.classList.remove('dark'); }
    const themeBtn = document.getElementById('themeToggle'); if(themeBtn) themeBtn.onclick = ()=>{ const isDark = document.body.classList.toggle('dark'); localStorage.setItem('theme', isDark? 'dark':'light'); };
    applyTheme();

    document.getElementById('logout').onclick = async ()=>{ await fetch('/api/logout', {method:'POST'}); location.href='/'; };
    load();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>